{{- $repo := .Values.global.repoURL -}}
{{- $root := .Values.global.rootPath | default "" -}}
{{- range $app := .Values.apps }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $app.name }}
  namespace: {{ $.Values.global.destinationNamespace | default "argocd" }}
spec:
  project: {{ $.Values.project.name | default "default" }}
  source:
    repoURL: {{ $repo | quote }}
    targetRevision: {{ (or $app.targetRevision $.Chart.AppVersion) | quote }}
    path: {{ printf "%s/%s" $root $app.path | trimPrefix "/" | quote }}
    {{- with $app.helm }}
    helm:
      {{- if .values }}
      values: |
{{ toYaml .values | indent 8 }}
      {{- end }}
      {{- with .parameters }}
      parameters:
{{ toYaml .parameters | indent 8 }}
      {{- end }}
    {{- end }}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ $app.destinationNamespace | default "default" }}
  syncPolicy:
    automated: { prune: true, selfHeal: true }
    syncOptions:
      - CreateNamespace=true
---
{{- end }}
