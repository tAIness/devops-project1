{{- /* ========================= In-repo apps (Git path + Helm values) ========================= */ -}}
{{- range $app := .Values.apps | default (list) }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $app.name }}
  namespace: {{ $.Values.global.argoNamespace | default "argocd" }}
  annotations:
    # Keep Argo CD tracking stable across renames:
    argocd.argoproj.io/tracking-id: {{ printf "%s:%s/%s:%s/%s" "argocd-apps" "argoproj.io" "Application" ($.Values.global.argoNamespace | default "argocd") $app.name }}
    # Force a diff when the release tag changes so spec.info updates:
    apps.tiny/release-tag: {{ default "unknown" $.Values.global.releaseTag | quote }}
spec:
  project: {{ $.Values.project.name | default "default" }}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ $app.destinationNamespace }}
  source:
    repoURL: {{ $.Values.global.repoURL }}
    targetRevision: {{ default "main" (default $app.targetRevision $.Values.global.targetRevision) }}
    path: {{ $app.path }}
    {{- if or $app.helm $app.values }}
    helm:
      {{- if $app.helm.valueFiles }}
      valueFiles:
{{ toYaml $app.helm.valueFiles | indent 8 }}
      {{- end }}
      {{- if $app.helm.values }}
      values: |
{{ toYaml $app.helm.values | indent 8 }}
      {{- else if $app.values }}
      values: |
{{ toYaml $app.values | indent 8 }}
      {{- end }}
    {{- end }}
  info:
    - name: Release
      value: {{ default "unknown" $.Values.global.releaseTag | quote }}
    - name: Image
      value: >-
        {{- $repo := (dig "image" "repository" "" $app.helm.values $app.values) -}}
        {{- $tag  := (default $.Values.global.releaseTag (dig "image" "tag" "" $app.helm.values $app.values)) -}}
        {{- if $repo }}{{ printf "%s:%s" $repo $tag }}{{ else }}unknown{{ end }}
  syncPolicy:
    automated: { prune: true, selfHeal: true }
    syncOptions: [ "CreateNamespace=true", "ServerSideApply=true", "Replace=true" ]
---
{{- end }}

{{- /* ========================= External Helm charts (chart repo) ========================= */ -}}
{{- range $h := .Values.helmApps | default (list) }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $h.name }}
  namespace: {{ $.Values.global.argoNamespace | default "argocd" }}
  annotations:
    apps.tiny/release-tag: {{ default "unknown" $.Values.global.releaseTag | quote }}
spec:
  project: {{ $.Values.project.name | default "default" }}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ $h.destinationNamespace }}
  source:
    repoURL: {{ $h.source.repoURL }}
    chart: {{ $h.source.chart }}
    targetRevision: {{ $h.source.targetRevision }}
    helm:
      {{- if hasKey $h "helm" }}
      {{- if hasKey $h.helm "skipCrds" }}
      skipCrds: {{ $h.helm.skipCrds }}
      {{- end }}
      {{- if hasKey $h.helm "values" }}
      values: |
{{ $h.helm.values | indent 8 }}
      {{- end }}
      {{- end }}
  info:
    - name: Chart
      value: "{{ $h.source.chart }}@{{ $h.source.targetRevision }}"
    - name: Release
      value: {{ default "unknown" $.Values.global.releaseTag | quote }}
  syncPolicy:
    automated: { prune: true, selfHeal: true }
    syncOptions: [ "CreateNamespace=true", "ServerSideApply=true", "Replace=true" ]
---
{{- end }}
