{{- $repo := .Values.global.repoURL -}}
{{- $root := .Values.global.rootPath | default "" -}}
{{- $argoNs := .Values.global.argoNamespace | default "argocd" -}}

{{- range .Values.apps }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ .name }}
  namespace: {{ $argoNs }}
spec:
  project: {{ $.Values.project.name | default "default" }}
  source:
    repoURL: {{ $repo | quote }}
    targetRevision: {{ (or .targetRevision $.Chart.AppVersion) | quote }}
    path: {{ printf "%s/%s" $root .path | trimPrefix "/" | quote }}
    {{- if .values }}
    helm:
      valuesObject:
{{ toYaml .values | indent 8 }}
    {{- end }}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ .destinationNamespace | default "default" }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
{{- end }}
