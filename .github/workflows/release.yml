name: Release

on:
  push:
    branches:
    - main
    tags:
    - 'v*.*.*'
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

env:
  # single place to compute the tag:
  IMAGE_TAG: ${{ github.ref_type == 'tag' && github.ref_name || 'edge' }}

jobs:
  build-and-push-app:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DOCKERHUB_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
      NEXUS_REGISTRY_DOMAIN: ${{ secrets.NEXUS_REGISTRY_DOMAIN }}
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ env.DOCKERHUB_TOKEN }}

    - name: Build & push app to Docker Hub
      uses: docker/build-push-action@v6
      with:
        context: ./app
        push: true
        tags: |
          ${{ env.DOCKERHUB_REPO_APP }}:${{ env.IMAGE_TAG }}
          ${{ env.DOCKERHUB_REPO_APP }}:latest

    - name: Login to Nexus (dev)
      if: ${{ env.NEXUS_REGISTRY_DOMAIN != '' && env.NEXUS_USERNAME != '' && env.NEXUS_PASSWORD != '' }}
      uses: docker/login-action@v3
      with:
        registry: ${{ env.NEXUS_REGISTRY_DOMAIN }}
        username: ${{ env.NEXUS_USERNAME }}
        password: ${{ env.NEXUS_PASSWORD }}

    - name: Tag & push app to Nexus (dev)
      if: ${{ env.NEXUS_REGISTRY_DOMAIN != '' && env.NEXUS_USERNAME != '' && env.NEXUS_PASSWORD != '' }}
      run: |
        docker pull ${{ env.DOCKERHUB_REPO_APP }}:${{ env.IMAGE_TAG }}
        docker tag ${{ env.DOCKERHUB_REPO_APP }}:${{ env.IMAGE_TAG }} ${{ env.NEXUS_REGISTRY_DOMAIN }}/devops-app:${{ env.IMAGE_TAG }}
        docker push ${{ env.NEXUS_REGISTRY_DOMAIN }}/devops-app:${{ env.IMAGE_TAG }}

  build-and-push-web:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DOCKERHUB_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
      NEXUS_REGISTRY_DOMAIN: ${{ secrets.NEXUS_REGISTRY_DOMAIN }}
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ env.DOCKERHUB_TOKEN }}

    - name: Build & push web to Docker Hub
      uses: docker/build-push-action@v6
      with:
        context: ./web
        push: true
        tags: |
          ${{ env.DOCKERHUB_REPO_WEB }}:${{ env.IMAGE_TAG }}
          ${{ env.DOCKERHUB_REPO_WEB }}:latest

    - name: Login to Nexus (dev)
      if: ${{ env.NEXUS_REGISTRY_DOMAIN != '' && env.NEXUS_USERNAME != '' && env.NEXUS_PASSWORD != '' }}
      uses: docker/login-action@v3
      with:
        registry: ${{ env.NEXUS_REGISTRY_DOMAIN }}
        username: ${{ env.NEXUS_USERNAME }}
        password: ${{ env.NEXUS_PASSWORD }}

    - name: Tag & push web to Nexus (dev)
      if: ${{ env.NEXUS_REGISTRY_DOMAIN != '' && env.NEXUS_USERNAME != '' && env.NEXUS_PASSWORD != '' }}
      run: |
        docker pull ${{ env.DOCKERHUB_REPO_WEB }}:${{ env.IMAGE_TAG }}
        docker tag ${{ env.DOCKERHUB_REPO_WEB }}:${{ env.IMAGE_TAG }} ${{ env.NEXUS_REGISTRY_DOMAIN }}/devops-web:${{ env.IMAGE_TAG }}
        docker push ${{ env.NEXUS_REGISTRY_DOMAIN }}/devops-web:${{ env.IMAGE_TAG }}

  snyk-release:
    name: Snyk release scan
    needs:
    - build-and-push-app
    - build-and-push-web
    uses: tAIness/devops-ci-lib/.github/workflows/snyk-reusable.yml@main
    secrets: inherit
    with:
      images: |
        ${{ secrets.DOCKERHUB_REPO_APP }}:${{ github.ref_type == 'tag' && github.ref_name || 'edge' }}
        ${{ secrets.DOCKERHUB_REPO_WEB }}:${{ github.ref_type == 'tag' && github.ref_name || 'edge' }}
      ignore_list_path: security/ignores.txt
      severity: high
      upload_artifacts: true
