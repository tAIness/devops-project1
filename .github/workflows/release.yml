# yamllint disable rule:line-length rule:indentation
---
name: Release

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target (mac = self-hosted, ec2 = remote EC2)"
        type: choice
        options: [mac, ec2]
        default: mac

permissions:
  contents: write
  packages: write

# Global toggle. You can also set repo Actions Variable DEPLOY_TARGET.
env:
  DEPLOY_TARGET: ${{ inputs.target || vars.DEPLOY_TARGET || 'mac' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  compute-tag:
    name: Compute next tag (when pushing to main)
    runs-on: ubuntu-latest
    if: ${{ github.ref_type == 'branch' && github.ref_name == 'main' }}
    outputs:
      tag: ${{ steps.bump.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Compute next tag (no create)
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          last="$(git tag -l 'v*.*.*' | sort -V | tail -n1)"
          if [[ -z "$last" ]]; then
            major=0 minor=1 patch=0
          else
            IFS=. read -r vM vN vP <<<"${last#v}"
            major="$vM"; minor="$vN"; patch="$vP"
            patch=$((patch+1))
          fi
          echo "tag=v${major}.${minor}.${patch}" >> "$GITHUB_OUTPUT"

  setup:
    name: Resolve image tag
    runs-on: ubuntu-latest
    needs: [compute-tag]
    outputs:
      IMAGE_TAG: ${{ steps.resolve.outputs.IMAGE_TAG }}
    steps:
      - id: resolve
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "IMAGE_TAG=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "IMAGE_TAG=${{ needs.compute-tag.outputs.tag }}" >> "$GITHUB_OUTPUT"
          fi

  bump-helm-appversion:
    name: Bump Helm appVersion in all charts & push
    runs-on: ubuntu-latest
    needs: [compute-tag]
    if: ${{ github.ref_type == 'branch' && github.ref_name == 'main' }}
    env:
      TAG: ${{ needs.compute-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install yq (static)
        run: |
          set -euo pipefail
          YQ_VERSION=v4.44.3
          OS=$(uname); ARCH=$(uname -m)
          case "$ARCH" in x86_64) ARCH=amd64;; aarch64|arm64) ARCH=arm64;; esac
          curl -fsSL -o /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_${OS}_${ARCH}"
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Update appVersion for ALL charts + write releaseTag
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t charts < <(git ls-files 'infra/helm/**/Chart.yaml')
          if (( ${#charts[@]} == 0 )); then
            echo "No Chart.yaml found under infra/helm"; exit 1
          fi
          printf 'Charts found:\n%s\n' "${charts[@]}"
          for f in "${charts[@]}"; do
            echo "Updating $f to appVersion=${TAG}"
            yq -i '.appVersion = env(TAG)' "$f"
          done
          echo "Setting global.releaseTag=${TAG} in infra/helm/argocd-apps/values.yaml"
          yq -i '.global.releaseTag = env(TAG)' infra/helm/argocd-apps/values.yaml

      - name: Commit & push change
        run: |
          set -euo pipefail
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          if git diff --quiet; then
            echo "No changes to commit."
          else
            git add infra/helm/**/Chart.yaml infra/helm/argocd-apps/values.yaml
            git commit -m "chore(helm): set appVersion & releaseTag ${TAG}"
            git push origin HEAD:main
          fi

  create-tag:
    name: Create & push git tag
    runs-on: ubuntu-latest
    needs: [compute-tag, bump-helm-appversion]
    if: ${{ github.ref_type == 'branch' && github.ref_name == 'main' }}
    env:
      TAG: ${{ needs.compute-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Configure git identity
        run: |
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

      - name: Tag & push
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${TAG:-}" ]]; then
            echo "ERROR: TAG is empty (compute-tag output missing). Aborting." >&2
            exit 1
          fi
          git fetch --all --tags
          git checkout main
          git pull --ff-only
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

  build-and-push-app:
    name: Build & push app image
    runs-on: ubuntu-latest
    needs: [setup]
    env:
      IMAGE_TAG: ${{ needs.setup.outputs.IMAGE_TAG }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DOCKERHUB_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build app (no push)
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: false
          load: true
          tags: ${{ env.DOCKERHUB_REPO_APP }}:${{ env.IMAGE_TAG }}

      - name: Push app with retry
        shell: bash
        env:
          REGISTRY_DOMAIN: https://index.docker.io/v1/
          REGISTRY_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          REGISTRY_PASSWORD: ${{ env.DOCKERHUB_TOKEN }}
          APP_IMAGE: ${{ env.DOCKERHUB_REPO_APP }}:${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_DOMAIN" -u "$REGISTRY_USERNAME" --password-stdin
          for i in 1 2 3 4 5; do
            echo "Push attempt $i for $APP_IMAGE…"
            if docker push "$APP_IMAGE"; then
              echo "Push succeeded for $APP_IMAGE."
              break
            fi
            echo "Push failed; re-login & backoff…"
            docker logout "$REGISTRY_DOMAIN" || true
            echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_DOMAIN" -u "$REGISTRY_USERNAME" --password-stdin
            sleep $((i*10))
            if [ "$i" = 5 ]; then echo "Push failed after retries"; exit 1; fi
          done

      - name: Mirror APP to Nexus on EC2
        if: ${{ env.DEPLOY_TARGET == 'ec2' }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          DOCKERHUB_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_REPO_APP: ${{ secrets.NEXUS_REPO_APP }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          envs: IMAGE_TAG,DOCKERHUB_REPO_APP,DOCKERHUB_USERNAME,DOCKERHUB_TOKEN,NEXUS_USERNAME,NEXUS_PASSWORD,NEXUS_REPO_APP
          script: |
            set -euo pipefail
            if ! command -v skopeo >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y skopeo
            fi
            SRC="docker://${DOCKERHUB_REPO_APP}:${IMAGE_TAG}"
            DST="docker://127.0.0.1:5000/${NEXUS_REPO_APP}:${IMAGE_TAG}"
            skopeo copy --src-creds "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" \
                        --dest-creds "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
                        --src-tls-verify=true --dest-tls-verify=false \
                        "${SRC}" "${DST}"
            skopeo copy --src-creds "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" \
                        --dest-creds "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
                        --src-tls-verify=true --dest-tls-verify=false \
                        "${SRC}" "docker://127.0.0.1:5000/${NEXUS_REPO_APP}:latest"

  build-and-push-web:
    name: Build & push web image
    runs-on: ubuntu-latest
    needs: [setup]
    env:
      IMAGE_TAG: ${{ needs.setup.outputs.IMAGE_TAG }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DOCKERHUB_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build web (no push)
        uses: docker/build-push-action@v6
        with:
          context: ./web
          push: false
          load: true
          tags: ${{ env.DOCKERHUB_REPO_WEB }}:${{ env.IMAGE_TAG }}

      - name: Push web with retry
        shell: bash
        env:
          REGISTRY_DOMAIN: https://index.docker.io/v1/
          REGISTRY_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          REGISTRY_PASSWORD: ${{ env.DOCKERHUB_TOKEN }}
          WEB_IMAGE: ${{ env.DOCKERHUB_REPO_WEB }}:${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_DOMAIN" -u "$REGISTRY_USERNAME" --password-stdin
          for i in 1 2 3 4 5; do
            echo "Push attempt $i for $WEB_IMAGE…"
            if docker push "$WEB_IMAGE"; then
              echo "Push succeeded for $WEB_IMAGE."
              break
            fi
            echo "Push failed; re-login & backoff…"
            docker logout "$REGISTRY_DOMAIN" || true
            echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_DOMAIN" -u "$REGISTRY_USERNAME" --password-stdin
            sleep $((i*10))
            if [ "$i" = 5 ]; then echo "Push failed after retries"; exit 1; fi
          done

      - name: Install skopeo
        run: |
          sudo apt-get update -y
          sudo apt-get install -y skopeo

      - name: Mirror WEB to Nexus on EC2
        if: ${{ env.DEPLOY_TARGET == 'ec2' }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          DOCKERHUB_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_REPO_WEB: ${{ secrets.NEXUS_REPO_WEB }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          envs: IMAGE_TAG,DOCKERHUB_REPO_WEB,DOCKERHUB_USERNAME,DOCKERHUB_TOKEN,NEXUS_USERNAME,NEXUS_PASSWORD,NEXUS_REPO_WEB
          script: |
            set -euo pipefail
            if ! command -v skopeo >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y skopeo
            fi
            SRC="docker://${DOCKERHUB_REPO_WEB}:${IMAGE_TAG}"
            DST="docker://127.0.0.1:5000/${NEXUS_REPO_WEB}:${IMAGE_TAG}"
            skopeo copy --src-creds "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" \
                        --dest-creds "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
                        --src-tls-verify=true --dest-tls-verify=false \
                        "${SRC}" "${DST}"
            skopeo copy --src-creds "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" \
                        --dest-creds "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" \
                        --src-tls-verify=true --dest-tls-verify=false \
                        "${SRC}" "docker://127.0.0.1:5000/${NEXUS_REPO_WEB}:latest"

  snyk-release:
    name: Snyk scan of images
    runs-on: ubuntu-latest
    needs: [setup, build-and-push-app, build-and-push-web]
    env:
      IMAGE_TAG: ${{ needs.setup.outputs.IMAGE_TAG }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      DOCKERHUB_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
      DOCKERHUB_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@0.4.0
      - run: snyk auth "$SNYK_TOKEN"

      - name: Build .snyk from ignore list (if present)
        shell: bash
        run: |
          set -euo pipefail
          touch .snyk
          if [[ -f "security/ignores.txt" ]]; then
            grep -v '^\s*#' security/ignores.txt | sed '/^\s*$/d' | while read -r ID; do
              snyk ignore --id="$ID" --reason="approved via repo ignore list" --expiry=2099-12-31 --yes --quiet || true
            done
          fi

      - name: Scan & save JSON
        id: scan
        shell: bash
        run: |
          set +e
          set -u -o pipefail
          printf "%s\n" \
            "${DOCKERHUB_REPO_APP}:${IMAGE_TAG}" \
            "${DOCKERHUB_REPO_WEB}:${IMAGE_TAG}" > images.txt
          failures=0
          while read -r IMG; do
            [[ -z "$IMG" ]] && continue
            SAFE="$(echo "$IMG" | tr '/:@' '___')"
            OUT="snyk-${SAFE}.json"
            snyk container test "$IMG" --severity-threshold=high --json-file-output="$OUT"
            rc=$?
            if [ ! -s "$OUT" ]; then
              snyk container test "$IMG" --severity-threshold=high --json > "$OUT" 2>/dev/null || echo '{"note":"no json"}' > "$OUT"
            fi
            if [ $rc -ne 0 ]; then failures=$((failures+1)); fi
          done < images.txt
          echo "failures=$failures" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-reports
          path: snyk-*.json
          if-no-files-found: warn

      - name: Fail if any image failed
        if: ${{ steps.scan.outputs.failures != '0' }}
        run: |
          echo "Blocking release: Snyk found issues above threshold."
          exit 1

  # --- Deploy to EC2 (gated by DEPLOY_TARGET) ---
  deploy-ec2:
    name: Deploy to EC2
    if: ${{ env.DEPLOY_TARGET == 'ec2' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')) }}
    runs-on: ubuntu-latest
    needs: [setup, build-and-push-app, build-and-push-web, snyk-release, create-tag]
    env:
      TAG: ${{ needs.setup.outputs.IMAGE_TAG }}
      DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DH_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
      DH_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
      REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      NEXUS_REPO_APP: ${{ secrets.NEXUS_REPO_APP }}
      NEXUS_REPO_WEB: ${{ secrets.NEXUS_REPO_WEB }}
      DEPLOY_REGISTRY: ${{ secrets.DEPLOY_REGISTRY }}
      FLASK_PORT: ${{ secrets.FLASK_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure target dir & perms
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          script: |
            set -e
            sudo mkdir -p /srv/supermario
            sudo chown -R $USER:$USER /srv/supermario

      - name: Upload compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          source: deploy/compose.yml
          target: /srv/supermario
          strip_components: 1

      - name: Upload static images
        if: ${{ hashFiles('content/images/**') != '' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          source: content/images/**
          target: /srv/supermario

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          TAG: ${{ needs.setup.outputs.IMAGE_TAG }}
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DH_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
          DH_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
          NEXUS_DOMAIN: ${{ secrets.NEXUS_REGISTRY_DOMAIN }}
          NEXUS_USER: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_REPO_APP: ${{ secrets.NEXUS_REPO_APP }}
          NEXUS_REPO_WEB: ${{ secrets.NEXUS_REPO_WEB }}
          DEPLOY_REGISTRY: ${{ secrets.DEPLOY_REGISTRY }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          FLASK_PORT: ${{ secrets.FLASK_PORT }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: TAG,DH_USER,DH_TOKEN,DH_REPO_APP,DH_REPO_WEB,NEXUS_DOMAIN,NEXUS_USER,NEXUS_PASS,NEXUS_REPO_APP,NEXUS_REPO_WEB,DEPLOY_REGISTRY,DB_NAME,DB_USER,DB_PASSWORD,DB_PORT,FLASK_PORT
          script: |
            set -eo pipefail
            sudo mkdir -p /srv/supermario/content/images
            cd /srv/supermario
            if [ -z "${TAG:-}" ]; then
              echo "ERROR: TAG is empty. Refuse to deploy." >&2
              exit 1
            fi
            REG="${DEPLOY_REGISTRY:-hub}"
            if [ "$REG" = "nexus" ]; then
              NEXUS_LOCAL="127.0.0.1:5000"
              echo "${NEXUS_PASS}" | sudo docker login "${NEXUS_LOCAL}" -u "${NEXUS_USER}" --password-stdin
              IMAGE_REPO_APP="${NEXUS_LOCAL}/${NEXUS_REPO_APP}"
              IMAGE_REPO_WEB="${NEXUS_LOCAL}/${NEXUS_REPO_WEB}"
            else
              echo "${DH_TOKEN}" | sudo docker login -u "${DH_USER}" --password-stdin
              IMAGE_REPO_APP="${DH_REPO_APP}"
              IMAGE_REPO_WEB="${DH_REPO_WEB}"
            fi
            {
              echo "IMAGE_REPO_APP=${IMAGE_REPO_APP}"
              echo "IMAGE_REPO_WEB=${IMAGE_REPO_WEB}"
              echo "TAG=${TAG}"
              echo "DB_NAME=${DB_NAME}"
              echo "DB_USER=${DB_USER}"
              echo "DB_PASSWORD=${DB_PASSWORD}"
              echo "DB_PORT=${DB_PORT:-5432}"
              echo "FLASK_PORT=${FLASK_PORT:-8000}"
            } | sudo tee .env >/dev/null
            echo "Pulling ${IMAGE_REPO_APP}:${TAG} and ${IMAGE_REPO_WEB}:${TAG}…"
            sudo docker pull "${IMAGE_REPO_APP}:${TAG}"
            sudo docker pull "${IMAGE_REPO_WEB}:${TAG}"
            sudo docker volume create supermario_db_data >/dev/null
            sudo docker compose -f compose.yml pull
            sudo docker compose -f compose.yml up -d --no-build
            sudo docker image prune -f

  # --- Deploy to Mac (self-hosted runner; default) ---
  deploy-mac:
    name: Deploy on Mac (self-hosted)
    if: ${{ env.DEPLOY_TARGET == 'mac' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')) }}
    runs-on: [self-hosted, mac]
    needs: [setup, build-and-push-app, build-and-push-web, snyk-release, create-tag]
    env:
      TAG: ${{ needs.setup.outputs.IMAGE_TAG }}
      DOCKERHUB_REPO_APP: ${{ secrets.DOCKERHUB_REPO_APP }}
      DOCKERHUB_REPO_WEB: ${{ secrets.DOCKERHUB_REPO_WEB }}
      DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DB_NAME: ${{ vars.DB_NAME }}
      DB_USER: ${{ vars.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ vars.DB_PORT }}
      FLASK_PORT: ${{ vars.FLASK_PORT }}
    steps:
      - uses: actions/checkout@v4

      - name: Write .env.local for local compose
        run: |
          mkdir -p mac-release-flow
          cat > mac-release-flow/.env.local <<EOF
          DOCKERHUB_REPO_APP=${{ env.DOCKERHUB_REPO_APP }}
          DOCKERHUB_REPO_WEB=${{ env.DOCKERHUB_REPO_WEB }}
          TAG=${{ env.TAG }}
          DB_NAME=${{ env.DB_NAME }}
          DB_USER=${{ env.DB_USER }}
          DB_PASSWORD=${{ env.DB_PASSWORD }}
          DB_PORT=${{ env.DB_PORT }}
          FLASK_PORT=${{ env.FLASK_PORT }}
          EOF

      - name: Optional Docker Hub login (to pull images)
        if: ${{ env.DH_USER != '' && env.DH_TOKEN != '' }}
        run: echo "${DH_TOKEN}" | docker login -u "${DH_USER}" --password-stdin

      - name: Ensure volume & best-effort pulls
        run: |
          docker volume create supermario_db_data >/dev/null
          docker pull "${DOCKERHUB_REPO_APP}:${TAG}" || true
          docker pull "${DOCKERHUB_REPO_WEB}:${TAG}" || true

      - name: Compose up on Mac
        run: |
          docker compose -f mac-release-flow/deploy/compose.local.yml up -d --no-build
          docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'

  notify-slack:
    if: ${{ always() }}
    needs:
      - compute-tag
      - setup
      - bump-helm-appversion
      - create-tag
      - build-and-push-app
      - build-and-push-web
      - snyk-release
      - deploy-ec2
      - deploy-mac
    uses: tAIness/devops-ci-lib/.github/workflows/slack-notify.yml@main
    secrets: inherit
    with:
      title: "Release: ${{ needs.setup.outputs.IMAGE_TAG || github.ref_name }}"
      status: ${{ (needs['build-and-push-app'].result == 'failure' || needs['build-and-push-web'].result == 'failure' || needs['snyk-release'].result == 'failure' || (env.DEPLOY_TARGET == 'ec2' && needs['deploy-ec2'].result == 'failure') || (env.DEPLOY_TARGET == 'mac' && needs['deploy-mac'].result == 'failure')) && 'failure' || 'success' }}
      only_on: "always"
      run_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      message: "Actor: @${{ github.actor }} · Ref: ${{ github.ref_name }}"
